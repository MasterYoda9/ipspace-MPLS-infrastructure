#
# Deploy IBGP and EBGP routing in a WAN fabric
#
---
- name: Create configuration changes directory
  local_action: file path={{configs}}/changes state=directory
  run_once: true
  check_mode: no
  changed_when: no

- name: Deploy configurations
  ios_config:
    provider: "{{ios_provider}}"
    src: "{{configs}}/{{inventory_hostname}}.bgp.cfg"
  tags: [ deploy ]
  register: changes

- name: Document changes
  copy:
    content: |
      *************************************
      BGP changes on {{inventory_hostname}}
      *************************************
      {% for line in changes.commands %}
      {{ line }}
      {% endfor %}
    dest: "{{configs}}/changes/{{inventory_hostname}}.bgp.changes"
  delegate_to: localhost
  check_mode: no

- assemble: src={{configs}}/changes dest={{configs}}/changes.txt
  check_mode: no
  changed_when: no
  delegate_to: localhost
  run_once: true

- name: Refresh BGP routers
  ios_command:
    provider: "{{ios_provider}}"
    commands: 
    - "clear ip bgp * all soft out"
  register: bgp_neighbors
  tags: [ deploy ]

- set_fact: deploy=1
  tags: [ deploy ]